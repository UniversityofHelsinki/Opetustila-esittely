uuid: ef0e543a-85e1-45ca-8772-45c5f4e0234e
langcode: en
status: true
dependencies:
  enforced:
    module:
      - migrate_plus
_core:
  default_config_hash: UODJQimrvJ84qp5KTZxMgc9M_HnDimhpGFb64twEa_I
id: optime_integration
class: null
field_plugin_method: null
cck_plugin_method: null
migration_tags: null
migration_group: optime
label: 'JSON import of spaces and related metadata from Optime'
source:
  plugin: url
  data_fetcher_plugin: http
  data_parser_plugin: json
  include_raw_data: true
  urls: 'https://helpdesk.it.helsinki.fi/sites/default/files/testdata/test_full.json'
  item_selector: 0
  constants:
    reservation_link_base: 'https://optime.helsinki.fi/Timetables/Room/'
  fields:
    -
      name: optime_id
      label: 'Unique identifier containing building and space (optime)'
      selector: id
    -
      name: optime_index
      label: 'Unique identifier containing building and space (optime)'
      selector: optimeIndex
    -
      name: space_description
      label: 'Name or description of space, added to title'
      selector: description
    -
      name: building_description
      label: 'Building description including address, added to title'
      selector: buildingDescription
    -
      name: equipment
      label: 'Equipment terms (term references)'
      selector: equipment
    -
      name: campus
      label: 'Campus term (required term reference)'
      selector: campus
    -
      name: building_id
      label: 'Building ID (used in search)'
      selector: building
    -
      name: last_changed_in_optime
      label: 'Last changed in optime (UNIX timestamp)'
      selector: changeDate
    -
      name: inactivate_in_optime
      label: 'Inactive (boolean, both optime and drupal have a setting that can be used to disallow publishing))'
      selector: inactive
    -
      name: optime_comments
      label: 'Comments from optime (unlikely to be shown directly in Drupal)'
      selector: comments
    -
      name: legacy_url
      label: 'Url in the old system, might be used for comparing data'
      selector: url
    -
      name: room_type
      label: 'Room type (term reference)'
      selector: roomTypeDescription
    -
      name: capacity
      label: 'Room capacity (integer)'
      selector: capacity
    -
      name: street_address
      label: 'Street address (taken from building description, last part)'
      selector: buildingDescription
  ids:
    optime_id:
      type: string
process:
  type:
    plugin: default_value
    default_value: space
  title:
    plugin: concat
    source:
      - building_description
      - space_description
    delimiter: ' - '
  uid:
    plugin: default_value
    default_value: 1
  field_optime_id: optime_id
  field_optime_index: optime_index
  field_building_id: building_id
  field_capacity: capacity
  field_last_changed_in_optime: last_changed_in_optime
  field_inactivate_in_optime: inactivate_in_optime
  field_optime_comments: optime_comments
  field_legacy_url/uri: legacy_url
  field_legacy_url/title:
    plugin: default_value
    default_value: 'Legacy url'
  field_reservation_link/uri:
    plugin: concat
    source:
      - constants/reservation_link_base
      - optime_id
    delimiter: ''
  field_reservation_link/title:
    plugin: default_value
    default_value: 'Optime reservation'
  'field_reservation_link/title''':
    plugin: default_value
    default_value: 'Optime reservation'
  field_street_address:
    -
      plugin: explode
      source: street_address
      delimiter: ', '
      strict: false
    -
      plugin: extract
      index:
        - 1
  field_campus:
    -
      plugin: entity_generate
      source: campus
      value_key: name
      bundle_key: vid
      bundle: campus
      entity_type: taxonomy_term
      ignore_case: true
  field_building:
    -
      plugin: entity_generate
      source: building_description
      value_key: name
      bundle: building
      entity_type: taxonomy_term
      ignore_case: true
  field_equipment:
    -
      plugin: entity_generate
      source: equipment
      value_key: name
      bundle: equipment
      entity_type: taxonomy_term
      ignore_case: true
  field_room_type:
    -
      plugin: entity_generate
      source: room_type
      value_key: name
      bundle: room_type
      entity_type: taxonomy_term
      ignore_case: true
  field_accessibility:
    -
      plugin: entity_generate
      source: accessibility
      value_key: name
      bundle: equipment
      entity_type: taxonomy_term
      ignore_case: true
destination:
  plugin: 'entity:node'
  default_bundle: space
  bundle: space
migration_dependencies: {  }
